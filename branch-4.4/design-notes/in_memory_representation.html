

<!DOCTYPE html>
<html class="no-js" lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title> In-Memory Representation | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />
    <link
      rel="icon"
      href="../_static/img/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="../_static/img/favicon-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      href="../_static/img/favicon-228x228.png"
      sizes="192x192"
    />
    <link
      rel="apple-touch-icon"
      href="../_static/img/favicon-228x228.png"
    />
    <meta
      name="msapplication-TileImage"
      href="../_static/img/favicon-228x228.png"
    />
    <link rel="canonical" href="https://docs.scylladb.com/" />
    <link rel="author" href="mailto:info@scylladb.com" />
  <!-- connect to domain of font files -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- optionally increase loading priority -->
  <link
    rel="preload"
    as="style"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- async CSS -->
  <link
    rel="stylesheet"
    media="print"
    onload="this.onload=null;this.removeAttribute('media');"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- no-JS fallback -->
  <noscript>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
    />
  </noscript>
  <link
    rel="stylesheet"
    href="../_static/css/main.css"
    type="text/css"
  />
  <link
    rel="stylesheet"
    href="../_static/pygments.css"
    type="text/css"
  /> <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />

  <script
    type="text/javascript"
    id="documentation_options"
    data-url_root="../"
    src="../_static/documentation_options.js"
  ></script>
  <script
    type="text/javascript"
    src="../_static/js/runtime.bundle.js"
  ></script>
  <script
    type="text/javascript"
    src="../_static/js/main.bundle.js"
  ></script> <script src="../_static/jquery.js"></script> <script src="../_static/underscore.js"></script> <script src="../_static/doctools.js"></script> <script src="../_static/language_data.js"></script> <script src="../_static/clipboard.min.js"></script> <script src="../_static/copybutton.js"></script>

    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-T8P2JP");
    </script>
    <!-- End Google Tag Manager -->
    <!-- Marketo -->
    <script type="text/javascript">
      (function () {
        var didInit = false;
        function initMunchkin() {
          if (didInit === false) {
            didInit = true;
            Munchkin.init("791-QBF-350");
          }
        }
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = "//munchkin.marketo.net/munchkin.js";
        s.onreadystatechange = function () {
          if (this.readyState == "complete" || this.readyState == "loaded") {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script>
    <!-- End Marketo -->
    <!-- Expertrec -->
    <script>
      var id = "e2077224-9ccf-11e9-a0c9-0242ac130002";
      var ci_search = document.createElement("script");
      ci_search.type = "text/javascript";
      ci_search.async = true;
      ci_search.src = "https://cse.expertrec.com/api/js/ci_common.js?id=" + id;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(ci_search, s);
    </script>
    <!-- End Expertrec -->

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/b1870adf6a.js"
      crossorigin="anonymous"
    ></script>
    <!-- End Font Awesome -->
  </head>
  
  <body>
     <header class="header">
  <div class="header-logo">
    <a class="header-logo__img" href="https://scylladb.com/">
      <img
        src="../_static/img/logo-scylla-docs.svg"
        alt="Scylla Documentation Logo"
      />
    </a>
    <span class="header-logo__bar"></span>
    <a class="header-logo__text" href="https://docs.scylladb.com/">
      Documentation
    </a>
  </div>
  <div class="header-navigation">
    <ul
      class="dropdown menu scylla-dropdown scylla-dropdown--header"
      data-dropdown-menu
    >
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Server <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--about-us"></i>Scylla Open
              Source</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--enterprise"></i>Scylla
              Enterprise</a
            >
          </li>
          <li>
            <a
              href="https://scylla.docs.scylladb.com/master/alternator/alternator.html"
            >
              <i class="scylla-icon scylla-icon--overview"></i>Scylla
              Alternator</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Cloud <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://cloud.scylladb.com/">
              <i class="scylla-icon scylla-icon--cloud"></i>Scylla Cloud</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/scylla-cloud/">
              <i class="scylla-icon scylla-icon--cloud-docs"></i>Scylla Cloud
              Docs</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Tools <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://manager.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--manager"></i>Scylla Manager</a
            >
          </li>
          <li>
            <a href="https://monitoring.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--monitoring"></i>Scylla
              Monitoring Stack</a
            >
          </li>
          <li>
            <a href="https://operator.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--operator"></i>Scylla Operator
            </a>
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Drivers <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/cql-drivers/"
            >
              <i class="scylla-icon scylla-icon--nsql-guides"></i>CQL Drivers
            </a>
          </li>
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/dynamo-drivers/"
            >
              <i class="scylla-icon scylla-icon--overview"></i>DynamoDB Drivers
            </a>
          </li>
        </ul>
      </li>
    </ul>
    <div class="header-button">
      <a href="https://www.scylladb.com/download/" class="button">Download</a>
    </div>
  </div>
  <div class="header-search-box">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav-toggle" data-toggle="side-nav">
  <div class="side-nav-toggle__button">
    <img src="../_static/img/menu.svg" alt="Menu" />
  </div>
</div>
</header>
    <section class="layout ">
      <div class="content large-order-2">
         

        <div class="admonition caution">
          <p class="admonition-title">Caution</p>
          <p>
             You
            are not reading the most current version of the documentation.  If you want up-to-date information, please have a look at

            <a href="../../stable/index.html">
               4.5  </a
            >.
          </p>
        </div>
        

        <div class="pre-content">
          <div class="pre-content__left"><div class="breadcrumbs">
  <span class="bread__item">
    <a
      href="https://scylla.docs.scylladb.com"
      class="bread__highlight"
    >
      <i class="fas fa-home"></i> Scylla Documentation</a
    ></span
  >
  
  <span class="bread__item"
    ><a href="index.html">Design Notes</a></span
  >
  
  <span class="bread__item bread__item--last">In-Memory Representation</span>
</div></div>
          <div class="pre-content__right"><ul
  class="dropdown menu scylla-dropdown scylla-dropdown--contribute"
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
      <div class="scylla-dropdown__title--body">
        <i class="icon fa fa-github" aria-hidden="true"></i>
        Contribute
      </div>
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content">
      <li>
        <a
          href="https://github.com/scylladb/scylla/issues/new?title=Issue in page In-Memory Representation&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://scylla.docs.scylladb.com/branch-4.4/design-notes/in_memory_representation%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix"
          target="_blank"
          >Report a doc issue
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
             
        <a
          href="https://github.com/scylladb/scylla/edit/branch-4.4/docs/design-notes/in_memory_representation.md"
          target="_blank"
          >Edit this page
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
        <a href="https://docs.scylladb.com/contribute/" target="_blank"
          >Learn how to contribute
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
    </ul>
  </li>
</ul></div>
        </div>
         <div class="section" id="in-memory-representation">
<h1>In-Memory Representation<a class="headerlink" href="#in-memory-representation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Instances of all C++ objects need to have their size fixed and known at compile
time. This is a significant restriction when it comes to minimising the memory
footprint of objects that are kept alive for a long amount of time.</p>
<p>Introducing a serialisation format that allows objects to be of a variable size
enables a range of possible optimisations, but manually writing serialisation
and deserialisation code for all required types would not only be tedious, but
also quite quickly result in an unmaintainable code.</p>
<p>IMR attempts to solve this problem by providing a general infrastructure for
serialisation and deserialisation with a goal of imposing as little limitations
as possible and generating as efficient code as possible.</p>
</div>
<div class="section" id="basic-concepts">
<h2>Basic concepts<a class="headerlink" href="#basic-concepts" title="Permalink to this headline">¶</a></h2>
<div class="section" id="contexts">
<h3>Contexts<a class="headerlink" href="#contexts" title="Permalink to this headline">¶</a></h3>
<p>The IMR expects that in many cases multiple objects will share certain
properties in a very predictable way. This can be taken advantage of by not
storing all the information necessary to correctly read IMR objects inside them,
but moving the shared part to an external state.</p>
<p>Fundamental and compound IMR types are designed with this in mind and many of
them require an external context to provide additional information necessary
during deserialisation.</p>
<p><em>For example, <code class="docutils literal notranslate"><span class="pre">imr::buffer&lt;Tag&gt;</span></code> doesn’t store its size anywhere, but requires
to be provided at deserialisation with a context object that implements
<code class="docutils literal notranslate"><span class="pre">size_of&lt;Tag&gt;()</span></code> member function.</em></p>
<p>The IMR itself doesn’t care about the source of the information the context
provide. It can come either from an external state that describes properties of
multiple instances of a particular IMR type or the context logic may read parts
of an IMR object itself. It is also worth noting that objects are not tied to
contexts in any way. The user code could use different context object (with
different internal logic) as long as the decisions it makes are the same and
sufficient for that particular use.</p>
<p><em>For example, in a structure a <code class="docutils literal notranslate"><span class="pre">imr::buffer&lt;Tag&gt;</span></code> could be preceded by an
integer which determines its size. When a context is created it takes a pointer
to the structure, reads the size field and returns it when asked by the buffer
deserialiser.</em></p>
<div class="section" id="context-factories">
<h4>Context factories<a class="headerlink" href="#context-factories" title="Permalink to this headline">¶</a></h4>
<p>In many cases a context is going to combine some external state and data stored
in an IMR object to provide information necessary to deserialise it. In order
to make creation of context more convenient context factories were introduced
which are objects that keep the external state and create an actual context
instance when given a pointer to an IMR object.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">context_factory</span><span class="o">&lt;</span><span class="n">ContextType</span><span class="p">,</span> <span class="n">ExternalState</span><span class="o">&gt;</span> <span class="n">factory</span><span class="p">(</span><span class="n">external_state</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">context</span> <span class="o">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">pointer_to_an_imr_object</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="views-mutable-views">
<h3>Views &amp; mutable views<a class="headerlink" href="#views-mutable-views" title="Permalink to this headline">¶</a></h3>
<p>The interface for deserialising an IMR object is built around views. An IMR type
given context and a pointer to an IMR object returns a view object that
provides methods specific for that type. For fundamental types these functions
will usually provide a way of creating an equivalent C++ type. In case of
compound types their views will allow accessing members in a checked or
unchecked manner.</p>
<p>Some IMR types can be updated in place. A mutable view of their instances can
be created which aside from providing an interface for reading the object will
also allow it to be updated.</p>
</div>
<div class="section" id="serialisers">
<h3>Serialisers<a class="headerlink" href="#serialisers" title="Permalink to this headline">¶</a></h3>
<p>IMR objects are serialised in three phases:</p>
<ol class="simple">
<li><p>Computing the object sizes and recording any necessary memory allocations.</p></li>
<li><p>Allocating memory. This is the only phase that can fail.</p></li>
<li><p>Writing serialised data.</p></li>
</ol>
<p>It is imperative that the decisions made in the first (sizing) and the third
(writing) phase are exactly the same. In order to make that easier to guarantee
the serialisation interfaces of many compound types accept a lambda template
which is first invoked with a sizer and later with a writer helper objects.</p>
<div class="section" id="placeholders">
<h4>Placeholders<a class="headerlink" href="#placeholders" title="Permalink to this headline">¶</a></h4>
<p>If all instances of an IMR type are guaranteed to be the same size it is
possible to defer their serialisation. The serialisation function can be given
a placeholder object which would later be set to an actual value.</p>
</div>
<div class="section" id="continuation-hooks">
<h4>Continuation hooks<a class="headerlink" href="#continuation-hooks" title="Permalink to this headline">¶</a></h4>
<p>Compound types can be nested, e.g. a member of a structure can be another
structure. However, as mentioned in the <a class="reference external" href="#serialisers">Serialisers</a> section the
basic interface for serialisation is to accept lambda objects. In case of
nested structures this would require creating a nested lambdas which can be
inconvenient and result in a code that is hard to follow.</p>
<p>The solution is to introduce continuation hooks to serialisation helpers. The
outer structure serialisation helper provides a <code class="docutils literal notranslate"><span class="pre">serialize_nested()</span></code> member
function for serialising the inner one. The function returns a serialisation
helper for the nested structure which behaves as the stand-alone one except
that when <code class="docutils literal notranslate"><span class="pre">done()</span></code> is called it returns back a serialisation helper for the
outer structure.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">serializer</span>
    <span class="p">.</span><span class="n">serialize</span><span class="p">(...)</span>
    <span class="p">.</span><span class="n">serialize_nested</span><span class="p">()</span>
        <span class="p">.</span><span class="n">serialize</span><span class="p">(...)</span>
        <span class="p">.</span><span class="n">done</span><span class="p">()</span>
    <span class="p">.</span><span class="n">serialize</span><span class="p">(...)</span>
    <span class="p">.</span><span class="n">done</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="imr-types">
<h3>IMR types<a class="headerlink" href="#imr-types" title="Permalink to this headline">¶</a></h3>
<div class="section" id="tags">
<h4>Tags<a class="headerlink" href="#tags" title="Permalink to this headline">¶</a></h4>
<p>IMR extensively uses tags to name members of a compound type or match an
instance of a type with an appropriate member function of the deserialisation
context.</p>
<p>Any type can be a tag, but it is customary to use incomplete classes with a
meaningful names for this purpose.</p>
<p>Reusing tags should be avoided in order to avoid clashes.</p>
</div>
<div class="section" id="type-concept">
<h4>Type concept<a class="headerlink" href="#type-concept" title="Permalink to this headline">¶</a></h4>
<p>Most IMR types follow a similar interface for serialisation and
deserialisation. There may be, however, some differences specific to a
particular type and its purpose.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">imr_type</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">auto</span> <span class="n">make_view</span><span class="p">(</span><span class="k">const</span> <span class="n">uint_t</span><span class="o">*</span> <span class="n">imr_object</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">auto</span> <span class="nf">make_view</span><span class="p">(</span><span class="n">uint_t</span><span class="o">*</span> <span class="n">imr_object</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>

    <span class="c1">// Returns the size of a serialized IMR object</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
    <span class="k">static</span> <span class="kt">size_t</span> <span class="n">serialized_object_size</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">imr_object</span><span class="p">,</span> <span class="k">const</span> <span class="n">Context</span><span class="o">&amp;</span> <span class="n">context</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>

    <span class="c1">// Returns the size of a serialized object without actually serializing it.</span>
    <span class="c1">// Arguments depend on the IMR type.</span>
    <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">size_when_serialized</span><span class="p">(...)</span> <span class="k">noexcept</span><span class="p">;</span>

    <span class="c1">// Returns the size of a serialized object. Arguments depend on the actual</span>
    <span class="c1">// IMR type.</span>
    <span class="k">static</span> <span class="kt">size_t</span> <span class="nf">serialize</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">out</span><span class="p">,</span> <span class="p">...)</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fundamental-types">
<h2>Fundamental types<a class="headerlink" href="#fundamental-types" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th>Type</th>
<th align="center">Fixed size</th>
<th align="center">Needs context</th>
<th align="center">In-place update</th>
<th align="center">Placeholders</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>flags</code></td>
<td align="center">Yes</td>
<td align="center">No</td>
<td align="center">Yes</td>
<td align="center">Yes</td>
</tr>
<tr>
<td><code>pod</code></td>
<td align="center">Yes</td>
<td align="center">No</td>
<td align="center">Yes</td>
<td align="center">Yes</td>
</tr>
<tr>
<td><code>buffer</code></td>
<td align="center">No</td>
<td align="center">Yes</td>
<td align="center">Yes (length cannot change)</td>
<td align="center">No</td>
</tr>
</tbody>
</table><div class="section" id="flags">
<h3><code class="docutils literal notranslate"><span class="pre">flags</span></code><a class="headerlink" href="#flags" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">set_flag</span> <span class="p">{</span>
    <span class="n">set_flag</span><span class="p">(</span><span class="kt">bool</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tags</span><span class="p">...</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">flags</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">view</span> <span class="p">{</span>
        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="o">&gt;</span>
        <span class="kt">bool</span> <span class="n">get</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>

        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="o">&gt;</span>
        <span class="kt">bool</span> <span class="n">set</span><span class="p">(</span><span class="kt">bool</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">// Sets flags which tags are present in Tags1, the remaining flags are</span>
    <span class="c1">// cleared.</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Tags1</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">imr</span><span class="o">::</span><span class="n">set_flag</span><span class="o">&lt;</span><span class="n">Tags1</span><span class="o">&gt;</span><span class="p">...)</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">flags</span></code> is a bitfield of named flags. Each declared flag uses exactly one bit
and the whole bitfield uses the smalles number of bytes possible to fit all
required bits.</p>
<p><code class="docutils literal notranslate"><span class="pre">flags</span></code> is a fixed-size type that can be updated in place and doesn’t require
and external context for deserialisation.</p>
</div>
<div class="section" id="pod">
<h3><code class="docutils literal notranslate"><span class="pre">pod</span></code><a class="headerlink" href="#pod" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">PODType</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">pod</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">view</span> <span class="p">{</span>
        <span class="n">PODType</span> <span class="n">load</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>
        <span class="kt">void</span> <span class="nf">store</span><span class="p">(</span><span class="n">PODType</span> <span class="n">object</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">PODType</span> <span class="n">object</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pod</span></code> is a POD object using the same representation as that defined by the C++
ABI including all the internal padding in case of compound types. It is
therefore recommended that <code class="docutils literal notranslate"><span class="pre">pod</span></code> is used exclusively to represent C++
fundamental types.</p>
<p><code class="docutils literal notranslate"><span class="pre">pod</span></code> is a fixed-size type which can be updated in place.
It does not require an external context for deserialisation.</p>
</div>
<div class="section" id="buffer">
<h3><code class="docutils literal notranslate"><span class="pre">buffer</span></code><a class="headerlink" href="#buffer" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">buffer</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">view</span> <span class="o">=</span> <span class="n">bytes_view</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">bytes_view</span><span class="p">)</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">buffer</span></code> is a type representing an array of bytes of an arbitrary length.</p>
<p><code class="docutils literal notranslate"><span class="pre">buffer</span></code> is a variable-size type which can be updated in-place as long as the
length of the buffer remains unchanged.</p>
<div class="section" id="context-requirements">
<h4>Context requirements<a class="headerlink" href="#context-requirements" title="Permalink to this headline">¶</a></h4>
<p>Deserialisation of <code class="docutils literal notranslate"><span class="pre">buffer</span></code> objects requires an external context providing the
following member:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="n">size_of</span><span class="o">&lt;</span><span class="n">Tag</span><span class="o">&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">Tag</span></code> is the same type as the one used as a template parameter for
<code class="docutils literal notranslate"><span class="pre">buffer</span></code>. <code class="docutils literal notranslate"><span class="pre">size_of()</span></code> is must return the length of the buffer.</p>
</div>
</div>
</div>
<div class="section" id="compound-types">
<h2>Compound types<a class="headerlink" href="#compound-types" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tagged-type">
<h3><code class="docutils literal notranslate"><span class="pre">tagged_type</span></code><a class="headerlink" href="#tagged-type" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="p">,</span> <span class="k">typename</span> <span class="n">IMRType</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="nl">tagged_type</span> <span class="p">:</span> <span class="n">IMRType</span> <span class="p">{</span> <span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tagged_type</span></code> is a thin wrapper around an IMR type that allows annotating it
with a tag without changing its views or serialisers in any way.</p>
<p>The main purpose of adding tags to the type name is to allow defining custom
methods for only some usage of a particular IMR type (see section
<a class="reference external" href="#methods">Methods</a>).</p>
</div>
<div class="section" id="optional">
<h3><code class="docutils literal notranslate"><span class="pre">optional</span></code><a class="headerlink" href="#optional" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="p">,</span> <span class="k">typename</span> <span class="n">IMRType</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">optional</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">view</span> <span class="p">{</span>
        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
        <span class="n">IMRType</span><span class="o">::</span><span class="n">view</span> <span class="n">get</span><span class="p">(</span><span class="k">const</span> <span class="n">Context</span><span class="o">&amp;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...)</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">optional</span></code> represents an object that may not be present in some circumstances.
Information whether it does is not stored in any sort of metadata, but the
deserialisation context is expected to provide it.</p>
<div class="section" id="id1">
<h4>Context requirements<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">is_present</span><span class="o">&lt;</span><span class="n">Tag</span><span class="o">&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>
</pre></div>
</div>
<p>Optionals require the deserialisation context to provide information whether
the underlying object is present.</p>
</div>
</div>
<div class="section" id="variant">
<h3><code class="docutils literal notranslate"><span class="pre">variant</span></code><a class="headerlink" href="#variant" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="p">,</span> <span class="k">typename</span> <span class="n">IMRType</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">alternative</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Alternatives</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">variant</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">view</span> <span class="p">{</span>
        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">AlternativeTag</span><span class="o">&gt;</span>
        <span class="k">auto</span> <span class="n">as</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>

        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Visitor</span><span class="o">&gt;</span>
        <span class="k">decltype</span><span class="p">(</span><span class="k">auto</span><span class="p">)</span> <span class="n">accept</span><span class="p">(</span><span class="n">Visitor</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">AlternativeTag</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...)</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">variant</span></code> is a compound type that has multiple alternatives, each being an
IMR type. At any time there is exactly one active alternative and it is the
only one that can be read. Variants do not store information about the active
alternative by themselves but rely on the external context to provide that
information.</p>
<div class="section" id="id2">
<h4>Context requirements<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">imr</span><span class="o">::</span><span class="n">variant</span><span class="o">::</span><span class="n">alternative_index</span> <span class="n">active_alternative_of</span><span class="o">&lt;</span><span class="n">Tag</span><span class="o">&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">AlternativeTag</span><span class="o">&gt;</span>
<span class="k">auto</span> <span class="n">context_for</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>
</pre></div>
</div>
<p>Variant requires deserialisation context to provide information which one of
its alternatives is active as well as context for deserialisation of that
alternative.</p>
</div>
</div>
<div class="section" id="structure">
<h3><code class="docutils literal notranslate"><span class="pre">structure</span></code><a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="p">,</span> <span class="k">typename</span> <span class="n">IMRType</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">member</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Members</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">structure</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">view</span> <span class="p">{</span>
        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">MemberTag</span><span class="o">&gt;</span>
        <span class="k">auto</span> <span class="n">get</span><span class="p">()</span> <span class="k">noexcept</span><span class="p">;</span>

        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">MemberTag</span><span class="o">&gt;</span>
        <span class="kt">size_t</span> <span class="n">offset_of</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Writer</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Writer</span><span class="o">&amp;&amp;</span><span class="p">,</span> <span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...)</span> <span class="k">noexcept</span><span class="p">;</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Tag</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
    <span class="k">auto</span> <span class="n">get_member</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">Context</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">structure_writer</span> <span class="p">{</span>
    <span class="c1">// For imr::optional:</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
    <span class="k">auto</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...);</span>

    <span class="k">auto</span> <span class="nf">skip</span><span class="p">();</span>

    <span class="c1">// For imr::variant:</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">AlternativeTag</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
    <span class="k">auto</span> <span class="n">serialize_as</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...);</span>

    <span class="c1">// For other types:</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
    <span class="k">auto</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...);</span>

    <span class="c1">// After all members:</span>
    <span class="k">auto</span> <span class="nf">done</span><span class="p">()</span> <span class="k">noexcept</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">structure</span></code> is a compound type that stores possibly multiple member objects
one after another. All members are always present and their IMR type is fixed.</p>
<p>The interface for serialising structures is based on serialisation helpers.
Methods <code class="docutils literal notranslate"><span class="pre">serialize()</span></code> and <code class="docutils literal notranslate"><span class="pre">size_when_serialized()</span></code> accept a lambda that would
be given a serialisation helper object. That object expects its member function
<code class="docutils literal notranslate"><span class="pre">serialize()</span></code> (there are slightly different ones for optional and variant
structure members) to be invoked with an arguments that would normally be passed
to methods <code class="docutils literal notranslate"><span class="pre">structure()</span></code> and <code class="docutils literal notranslate"><span class="pre">size_when_serialized()</span></code> of the type of the member
that is being serialised (in the order they appear in the structure definition).
After the last member has been serialised <code class="docutils literal notranslate"><span class="pre">done()</span></code> is to be called and its
return value returned from the lambda.</p>
<div class="section" id="id3">
<h4>Context requirements<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">AlternativeTag</span><span class="o">&gt;</span>
<span class="k">auto</span> <span class="n">context_for</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h2>
<p>IMR types can define destructor and mover methods. Their goal is to provide
similar functionality to C++ destructors and move constructors and thus enable
owning references inside IMR objects. Movers are also essential in ensuring
that all references are properly updated when LSA moves objects around.</p>
<p>The default mover and destructor for fundamental types does nothing. The
default methods for compound types and containers invokes that method for
all present elements in an unspecified order.</p>
<p>User can define mover and destructor methods for any IMR type which would
override any default methods that this type might have.</p>
<p>Neither movers nor destructors are allowed to fail.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">mover</span><span class="o">&lt;</span><span class="n">IMRType</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">run</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">const</span> <span class="n">Context</span><span class="o">&amp;</span> <span class="n">ctx</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
        <span class="c1">// user-defined mover action</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="k">struct</span> <span class="n">imr</span><span class="o">::</span><span class="n">destructor</span><span class="o">&lt;</span><span class="n">IMRType</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">run</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">const</span> <span class="n">Context</span><span class="o">&amp;</span> <span class="n">ctx</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
        <span class="c1">// user-defined destructor action</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="section" id="mover">
<h3>Mover<a class="headerlink" href="#mover" title="Permalink to this headline">¶</a></h3>
<p>When an IMR object is being moved its serialised form is copied to the new
place in memory and then a mover method is called with the address of the new
location passed as an argument.</p>
<p><em>Note that, unlike C++, IMR does not call the destructor of the object moved
from. In other words, while moving in C++ involves creating a new object that
steals internal state from another, IMR just copies the object to the new
location and invokes a mover to give it a chance to do necessary updates, it is
however still considered to be the same object as the original one.</em></p>
</div>
<div class="section" id="destructor">
<h3>Destructor<a class="headerlink" href="#destructor" title="Permalink to this headline">¶</a></h3>
<p>The destructor of an IMR object is called before the storage it occupies is
freed. The address of the object passed to the destructor is either a location
at which the object was originally created or the address that was given to the
latest invocation of the object mover method.</p>
</div>
</div>
<div class="section" id="memory-allocations">
<h2>Memory allocations<a class="headerlink" href="#memory-allocations" title="Permalink to this headline">¶</a></h2>
<p>IMR objects are allowed to own memory and it is therefore expected that during
serialisation there will be a need to perform allocation. A convenience class
<code class="docutils literal notranslate"><span class="pre">imr::alloc::object_allocator</span></code> exists to aid this process.</p>
<p>The object allocator provides serialisation helpers for both sizing and writing
phases, which act similarily to the structure serialisation helpers and return
a pointer to the owned object. After the sizing phase member function
<code class="docutils literal notranslate"><span class="pre">allocate_all()</span></code> needs to be called which allocates all the reserved buffers.</p>
<p><em>Note that in case there is a chain of owned objects (e.g. a list) placeholders
can be used for pointers to avoid recursion.</em></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">imr_type1</span> <span class="o">=</span> <span class="p">...;</span>
<span class="k">using</span> <span class="n">imr_type2</span> <span class="o">=</span> <span class="p">...;</span>

<span class="n">imr</span><span class="o">::</span><span class="n">alloc</span><span class="o">::</span><span class="n">object_allocator</span> <span class="n">allocator</span><span class="p">;</span>

<span class="k">auto</span> <span class="n">writer</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">(</span><span class="k">auto</span> <span class="n">serializer</span><span class="p">,</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">allocator</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
    <span class="n">imr</span><span class="o">::</span><span class="n">placeholder</span><span class="o">&lt;</span><span class="n">imr</span><span class="o">::</span><span class="n">pod</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;&gt;</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">serializer</span>
        <span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">pointer</span><span class="p">)</span>
        <span class="p">.</span><span class="n">done</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">pointer_to_owned_object</span> <span class="o">=</span> <span class="n">allocator</span><span class="p">.</span><span class="n">allocate_nested</span><span class="o">&lt;</span><span class="n">imr_type2</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="p">.</span><span class="n">serialize</span><span class="p">(...)</span>
        <span class="p">.</span><span class="n">serialize</span><span class="p">(...)</span>
        <span class="p">.</span><span class="n">done</span><span class="p">();</span>

    <span class="n">pointer</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">pointer_to_owned_object</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">imr_type1</span><span class="o">::</span><span class="n">size_when_serialized</span><span class="p">(</span><span class="n">writer</span> <span class="p">,</span> <span class="n">allocator</span><span class="p">.</span><span class="n">get_size</span><span class="p">());</span>

<span class="k">auto</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">total_storage</span><span class="p">());</span>
<span class="n">allocator</span><span class="p">.</span><span class="n">allocate_all</span><span class="p">();</span>

<span class="n">imr_type1</span><span class="o">::</span><span class="n">serialize</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">writer</span><span class="p">,</span> <span class="n">allocator</span><span class="p">.</span><span class="n">get_serializer</span><span class="p">());</span>
</pre></div>
</div>
<div class="section" id="log-structured-allocator-support">
<h3>Log-Structured Allocator support<a class="headerlink" href="#log-structured-allocator-support" title="Permalink to this headline">¶</a></h3>
<p>LSA relies on migrator objects to provide logic necessary for moving objects
and obtaining their size. To do these action the information about the IMR type
of the object needs to be preserved as well as at least minimal external
context sufficient for calling the mover.</p>
<p>A helper class template is provided which takes the IMR type and (context
factory)[#context_factories] type as template parameters as well as actual
context factory in constructor and implements <code class="docutils literal notranslate"><span class="pre">migrate_fn_type</span></code> interface.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">imr</span><span class="o">::</span><span class="n">alloc</span><span class="o">::</span><span class="n">lsa_migrate_fn</span><span class="o">&lt;</span><span class="n">IMRType</span><span class="p">,</span> <span class="n">ContextFactory</span><span class="o">&gt;</span> <span class="n">migrator</span><span class="p">(</span><span class="n">context_factory</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">current_allocator</span><span class="p">().</span><span class="n">alloc</span><span class="p">(</span><span class="n">migrator</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>
  <div class="content-navigation">
  <div class="navigation navigation--prev">
    <a class="navigation__link" href="hinted_handoff_design.html">
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-left"></i>
      </button>
      <div class="navigation__title">
        <span class="colored">PREVIOUS</span> <br />Hinted Handoff Design
      </div>
    </a>
  </div>
  <div class="navigation navigation--next">
    <a class="navigation__link" href="isolation.html">
      <div class="navigation__title">
        <span class="colored">NEXT</span> <br />Performance Isolation in Scylla
      </div>
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-right"></i>
      </button>
    </a>
  </div>
</div> 
      </div>
      <div
        class="sidebar-left  large-order-1"
      > <div id="side-nav" class="side-nav" data-closable data-toggler=".show">
  <div class="side-nav__search">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav__versions">
     <ul
  class="dropdown menu scylla-dropdown scylla-dropdown--versions "
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
       4.4 
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content"> 
      <li>
        <a href="../../stable/index.html"
          >4.5</a
        >
      </li>
       
      <li>
        <a href="in_memory_representation.html"
          >4.4</a
        >
      </li>
       
    </ul>
  </li>
</ul> 
  </div>
  <div class="side-nav__content">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Scylla Developer Documentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../alternator/alternator.html">Alternator: DynamoDB API in Scylla</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../alternator/getting-started.html">Getting Started With ScyllaDB Alternator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alternator/compatibility.html">Scylla Alternator for DynamoDB users</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Design Notes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="scylla-icon scylla-icon--expand"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="IDL.html">IDL definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdc.html">CDC</a></li>
<li class="toctree-l2"><a class="reference internal" href="compaction_controller.html">The Compaction Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql-extensions.html">Scylla CQL extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql3-type-mapping.html">CQL3 Type Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="hinted_handoff_design.html">Hinted Handoff Design</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">In-Memory Representation</a></li>
<li class="toctree-l2"><a class="reference internal" href="isolation.html">Performance Isolation in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="lua-type-mapping.html">CQL to Lua type mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html">Scylla Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating-from-users-to-roles.html">Migrating from users to roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="paged-queries.html">Paged queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol-extensions.html">Protocol extensions to the Cassandra Native Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocols.html">Ports and protocols in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="redis.html">Redis API in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="repair_based_node_ops.html">Repair based node operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="row_cache.html">Row Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="row_level_repair.html">Row level repair</a></li>
<li class="toctree-l2"><a class="reference internal" href="secondary_index.html">Secondary indexes in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="sstable-scylla-format.html">File format of the Scylla.db sstable component</a></li>
<li class="toctree-l2"><a class="reference internal" href="sstables-directory-structure.html">sstables directory structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_keyspace.html">System keyspace layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_schema_keyspace.html">System schema keyspace layout</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../guides/HACKING.html">Guidelines for developing Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/api_v2.html">Scylla RESTful API V2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/building.html">Building Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/debugging.html">Debugging with GDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/docker-hub.html">Docker Hub Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/logging.html">Logging in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/tracing.html">Tracing</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contribute/index.html">Contribute</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contribute/CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/backport.html">Backport</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/coding-style.html">Scylla Coding Style</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/maintainer.html">Maintainer’s handbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/review-checklist.html">Review Checklist</a></li>
</ul>
</li>
</ul>

  </div>
</div>
      </div>
      
      <div class="sidebar-right large-order-3">
         <div class="secondary-side-nav">
  <div class="secondary-side-nav__content">
    <p class="topic-title">On this page</p>
    <ul>
<li><a class="reference internal" href="#">In-Memory Representation</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#basic-concepts">Basic concepts</a><ul>
<li><a class="reference internal" href="#contexts">Contexts</a><ul>
<li><a class="reference internal" href="#context-factories">Context factories</a></li>
</ul>
</li>
<li><a class="reference internal" href="#views-mutable-views">Views &amp; mutable views</a></li>
<li><a class="reference internal" href="#serialisers">Serialisers</a><ul>
<li><a class="reference internal" href="#placeholders">Placeholders</a></li>
<li><a class="reference internal" href="#continuation-hooks">Continuation hooks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#imr-types">IMR types</a><ul>
<li><a class="reference internal" href="#tags">Tags</a></li>
<li><a class="reference internal" href="#type-concept">Type concept</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#fundamental-types">Fundamental types</a><ul>
<li><a class="reference internal" href="#flags"><code class="docutils literal notranslate"><span class="pre">flags</span></code></a></li>
<li><a class="reference internal" href="#pod"><code class="docutils literal notranslate"><span class="pre">pod</span></code></a></li>
<li><a class="reference internal" href="#buffer"><code class="docutils literal notranslate"><span class="pre">buffer</span></code></a><ul>
<li><a class="reference internal" href="#context-requirements">Context requirements</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#compound-types">Compound types</a><ul>
<li><a class="reference internal" href="#tagged-type"><code class="docutils literal notranslate"><span class="pre">tagged_type</span></code></a></li>
<li><a class="reference internal" href="#optional"><code class="docutils literal notranslate"><span class="pre">optional</span></code></a><ul>
<li><a class="reference internal" href="#id1">Context requirements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#variant"><code class="docutils literal notranslate"><span class="pre">variant</span></code></a><ul>
<li><a class="reference internal" href="#id2">Context requirements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#structure"><code class="docutils literal notranslate"><span class="pre">structure</span></code></a><ul>
<li><a class="reference internal" href="#id3">Context requirements</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#methods">Methods</a><ul>
<li><a class="reference internal" href="#mover">Mover</a></li>
<li><a class="reference internal" href="#destructor">Destructor</a></li>
</ul>
</li>
<li><a class="reference internal" href="#memory-allocations">Memory allocations</a><ul>
<li><a class="reference internal" href="#log-structured-allocator-support">Log-Structured Allocator support</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div> 
      </div>
    </section>

    <footer class="footer">
  <div class="footer-group">
    <div class="footer-top">
      <a class="footer-logo" href="https://www.scylladb.com"
        ><img
          src="../_static/img/logo-scylla-horizontal-RGB.svg"
          alt="Logo"
      /></a>
      <div class="footer-links">
        <a class="footer-links__link" href="https://docs.scylladb.com/">Docs</a>
        <a
          class="footer-links__link"
          href="https://www.scylladb.com/company/contact-us/"
          >Contact Us</a
        >
        <a class="footer-links__link" href="https://www.scylladb.com/company/"
          >About Us</a
        >
      </div>
      <div class="footer-actions">
        <a
          class="footer-actions__link"
          href="https://groups.google.com/g/scylladb-users"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User mailing list"
            data-position="bottom"
          >
            <img
              src="../_static/img/icons/icon-mail-list.svg"
              alt="Mail List Icon"
            />
          </span>
        </a>
        <a
          class="footer-actions__link"
          href="http://slack.scylladb.com/"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User Slack channel"
            data-position="bottom"
          >
            <img
              src="../_static/img/icons/icon-slack.svg"
              alt="Slack Icon"
          /></span>
        </a>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="footer-bottom__copyright"> &#169; 2021, ScyllaDB. All rights reserved.
      </div>
      <div class="footer-bottom__last-updated">
        Last updated on 02 December 2021.
      </div>
      <div class="footer-bottom__version">
        Powered by
        <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a> &amp;
        <a href="https://sphinx-theme.scylladb.com/"
          >ScyllaDB Theme 1.0.5</a
        >
      </div>
    </div>
  </div>
</footer>

    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe>
    </noscript>
  </body>
</html>