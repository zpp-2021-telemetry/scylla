

<!DOCTYPE html>
<html class="no-js" lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title> Redis API in Scylla | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />
    <link
      rel="icon"
      href="../_static/img/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="../_static/img/favicon-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      href="../_static/img/favicon-228x228.png"
      sizes="192x192"
    />
    <link
      rel="apple-touch-icon"
      href="../_static/img/favicon-228x228.png"
    />
    <meta
      name="msapplication-TileImage"
      href="../_static/img/favicon-228x228.png"
    />
    <link rel="canonical" href="https://docs.scylladb.com/" />
    <link rel="author" href="mailto:info@scylladb.com" />
  <!-- connect to domain of font files -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- optionally increase loading priority -->
  <link
    rel="preload"
    as="style"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- async CSS -->
  <link
    rel="stylesheet"
    media="print"
    onload="this.onload=null;this.removeAttribute('media');"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- no-JS fallback -->
  <noscript>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
    />
  </noscript>
  <link
    rel="stylesheet"
    href="../_static/css/main.css"
    type="text/css"
  />
  <link
    rel="stylesheet"
    href="../_static/pygments.css"
    type="text/css"
  /> <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />

  <script
    type="text/javascript"
    id="documentation_options"
    data-url_root="../"
    src="../_static/documentation_options.js"
  ></script>
  <script
    type="text/javascript"
    src="../_static/js/runtime.bundle.js"
  ></script>
  <script
    type="text/javascript"
    src="../_static/js/main.bundle.js"
  ></script> <script src="../_static/jquery.js"></script> <script src="../_static/underscore.js"></script> <script src="../_static/doctools.js"></script> <script src="../_static/language_data.js"></script> <script src="../_static/clipboard.min.js"></script> <script src="../_static/copybutton.js"></script>

    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-T8P2JP");
    </script>
    <!-- End Google Tag Manager -->
    <!-- Marketo -->
    <script type="text/javascript">
      (function () {
        var didInit = false;
        function initMunchkin() {
          if (didInit === false) {
            didInit = true;
            Munchkin.init("791-QBF-350");
          }
        }
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = "//munchkin.marketo.net/munchkin.js";
        s.onreadystatechange = function () {
          if (this.readyState == "complete" || this.readyState == "loaded") {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script>
    <!-- End Marketo -->
    <!-- Expertrec -->
    <script>
      var id = "e2077224-9ccf-11e9-a0c9-0242ac130002";
      var ci_search = document.createElement("script");
      ci_search.type = "text/javascript";
      ci_search.async = true;
      ci_search.src = "https://cse.expertrec.com/api/js/ci_common.js?id=" + id;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(ci_search, s);
    </script>
    <!-- End Expertrec -->

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/b1870adf6a.js"
      crossorigin="anonymous"
    ></script>
    <!-- End Font Awesome -->
  </head>
  
  <body>
     <header class="header">
  <div class="header-logo">
    <a class="header-logo__img" href="https://scylladb.com/">
      <img
        src="../_static/img/logo-scylla-docs.svg"
        alt="Scylla Documentation Logo"
      />
    </a>
    <span class="header-logo__bar"></span>
    <a class="header-logo__text" href="https://docs.scylladb.com/">
      Documentation
    </a>
  </div>
  <div class="header-navigation">
    <ul
      class="dropdown menu scylla-dropdown scylla-dropdown--header"
      data-dropdown-menu
    >
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Server <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--about-us"></i>Scylla Open
              Source</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--enterprise"></i>Scylla
              Enterprise</a
            >
          </li>
          <li>
            <a
              href="https://scylla.docs.scylladb.com/master/alternator/alternator.html"
            >
              <i class="scylla-icon scylla-icon--overview"></i>Scylla
              Alternator</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Cloud <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://cloud.scylladb.com/">
              <i class="scylla-icon scylla-icon--cloud"></i>Scylla Cloud</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/scylla-cloud/">
              <i class="scylla-icon scylla-icon--cloud-docs"></i>Scylla Cloud
              Docs</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Tools <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://manager.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--manager"></i>Scylla Manager</a
            >
          </li>
          <li>
            <a href="https://monitoring.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--monitoring"></i>Scylla
              Monitoring Stack</a
            >
          </li>
          <li>
            <a href="https://operator.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--operator"></i>Scylla Operator
            </a>
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Drivers <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/cql-drivers/"
            >
              <i class="scylla-icon scylla-icon--nsql-guides"></i>CQL Drivers
            </a>
          </li>
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/dynamo-drivers/"
            >
              <i class="scylla-icon scylla-icon--overview"></i>DynamoDB Drivers
            </a>
          </li>
        </ul>
      </li>
    </ul>
    <div class="header-button">
      <a href="https://www.scylladb.com/download/" class="button">Download</a>
    </div>
  </div>
  <div class="header-search-box">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav-toggle" data-toggle="side-nav">
  <div class="side-nav-toggle__button">
    <img src="../_static/img/menu.svg" alt="Menu" />
  </div>
</div>
</header>
    <section class="layout ">
      <div class="content large-order-2">
         

        <div class="pre-content">
          <div class="pre-content__left"><div class="breadcrumbs">
  <span class="bread__item">
    <a
      href="https://scylla.docs.scylladb.com"
      class="bread__highlight"
    >
      <i class="fas fa-home"></i> Scylla Documentation</a
    ></span
  >
  
  <span class="bread__item"
    ><a href="index.html">Design Notes</a></span
  >
  
  <span class="bread__item bread__item--last">Redis API in Scylla</span>
</div></div>
          <div class="pre-content__right"><ul
  class="dropdown menu scylla-dropdown scylla-dropdown--contribute"
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
      <div class="scylla-dropdown__title--body">
        <i class="icon fa fa-github" aria-hidden="true"></i>
        Contribute
      </div>
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content">
      <li>
        <a
          href="https://github.com/scylladb/scylla/issues/new?title=Issue in page Redis API in Scylla&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://scylla.docs.scylladb.com/branch-4.5/design-notes/redis%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix"
          target="_blank"
          >Report a doc issue
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
             
        <a
          href="https://github.com/scylladb/scylla/edit/branch-4.5/docs/design-notes/redis.md"
          target="_blank"
          >Edit this page
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
        <a href="https://docs.scylladb.com/contribute/" target="_blank"
          >Learn how to contribute
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
    </ul>
  </li>
</ul></div>
        </div>
         <div class="section" id="redis-api-in-scylla">
<h1>Redis API in Scylla<a class="headerlink" href="#redis-api-in-scylla" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Redis is a very  famous NoSQL in-memory data structure store that stores a
mapping of keys to different types of values, and familiar to many developers.
It supports data structures such as STRINGs, HASHes, LISTs, SETs, ZSETs(sorted sets),
and other data structures. Redis has built-in replication, Lua
scripting, LRU eviction, transactions and different levels of on-disk
persistence. Now Redis as memory store service is provided by many cloud
platforms.</p>
<p>In this document, the detailed design and implementation of Redis that build on
top of Scylla is provided. At the beginning, the main feature, which is as a
data structures store, is design and  implmented. In the future, the reset
features of Redis will be supported.</p>
</div>
<div class="section" id="motivation">
<h2>2. Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>In contrast,  <a class="reference external" href="https://www.scylladb.com/">Scylla</a> has advantage and amazing
features:</p>
<ul class="simple">
<li><p>Low and consistent latency</p></li>
<li><p>Data persistence</p></li>
<li><p>High availability</p></li>
<li><p>High throughtput</p></li>
<li><p>Highly scalable</p></li>
<li><p>Auto tuning</p></li>
</ul>
<p>If Redis build on the top of Scylla, it has the above features automatically.
It’s achived great progress in cluster master managment, data persistence,
failover and replication.</p>
<p>The benefits to the users are easy to use and develop in their production
environment, and taking avantages of Scylla.</p>
</div>
<div class="section" id="the-protocol-server">
<h2>3. The Protocol Server<a class="headerlink" href="#the-protocol-server" title="Permalink to this headline">¶</a></h2>
<p>Redis clients communicate with the Redis server using a protocol called
<strong>RESP</strong> (REdis Serialization Protocol). The protocol is binary-safe and
easy to be implement at client side, which was designed specifically for
Redis.</p>
<p>Redis server accepts commands composed of different arguments. Once a
command is received, it’s processed and a reply is sent back to the client.
Two kind of Redis clients are widely used, the smart Redis client and
simple Redis client. When using smart Redis client to connect the Redis
cluster, it will send the commands to the right Redis server. Because the
client will get the hash slots and server nodes mapping data at the bootrap
time. When using simple Redis client,  the server address is needed, and
all the requests are sent to this address, and the requests only send to
the single Redis server.</p>
<p>In Scylla terminology, the node receiving the request acts as the the
coordinator, and often passes the request on to one or more other nodes,
which hold copies of the requested data.  Any node of Scylla cluster can
process the request correctly. In other words, Client can send request to
any node of Redis cluster built on the top of Scylla. Obviously, the simple
client can accesses the Redis cluster built on the top of Scylla, when
provided address is not an IP but rather a single domain name, which a
client resloves a random Scylla node IP address. The smart Redis client
queries the mapping information between hash slots and Server nodes. We
just fill the mapping with random Scylla node IP address.</p>
<p>Before you can start using Scylla with Redis API, you must set the
<code class="docutils literal notranslate"><span class="pre">redis-port</span></code> configuration option (visa the command line or YAML),
to available port. By default, the Redis API is disabled.
In Scylla, SSL for Redis API is supported. To enable it,
you must set the <code class="docutils literal notranslate"><span class="pre">redis-ssl-port</span></code> configuration option to available port.
This feature is disabled by default.</p>
<p>With Redis enabled, every Scylla node listens for Redis requests on the port.
These requests, in <a class="reference external" href="https://redis.io/topics/protocol">RESP</a> format over TCP,
are parsed and result in calls to internal Scylla C++ functions.</p>
</div>
<div class="section" id="data-model">
<h2>4. Data Model<a class="headerlink" href="#data-model" title="Permalink to this headline">¶</a></h2>
<p>Out of box, every Redis cluster supports 16 databases. The default database
is 0 but it allows us to change that to any number from 0-15 (and allow us
to configure Redis to support more databases). Each database provides
a distinct keyspace, independent from the others. Use <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">n</span></code>
to change databases. Redis allows us to store keys that map to any one of
five different  basic data structure types:  STRINGs,  LISTs,  SETs,
HASHes, and  ZSETs. (In fact, Now Redis has support other structure types,
but the basic structure types are used widely).</p>
<p>In this proposal, We use the column family of Scylla to simulate the
database within Redis. At the bootrap phase, the column familes with fixed
name should be created (if not exists) or loaded.</p>
<p>We known that, Redis allows us to store keys that map to any one of the
basic data structures. Scylla supports variant type, which allows us to
define one table to store all kind of these Redis data. For example ,we
create the table with the schame as follow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CREATE TABLE redis （
    key text,
    value variant\&lt;text, list\&lt;text\&gt;, map\&lt;text\&gt;\&gt;,
    PRIMARY KEY(key)
）WITH ...
</pre></div>
</div>
<p>However,  it’s need to prefetch the whole elements of this type structure
into memory in Scylla, even modifying only one element of the structures.
The main limitation is that the size of the data structure is not allowed
to be exceeded the limit of the server’s memory size. And the operations
will have more performance cost with bigger data structure.</p>
<blockquote>
<div><p>In Redis, maximum length of a list is 23^2  - 1 elements (4294967295,
more than 4 billion of elements per list). And maximum length of
element (as a string) is 512MB. It’s very common that the size of data
structure is exceeded the server’s memory size.</p>
</div></blockquote>
<p>So single table to store all the data strucutures is not good idea, instead
of five independent tables are created to hold the the different Redis
structure types within each column family related Redis database. In other
words, all of the STRINGs of the Redis will be stored in a table within the
column family, and all of the LISTs’ elements will be stored in anther
table within the column family, and so on.</p>
<blockquote>
<div><p>When building Redis on top of Scylla, for every Redis  database (16
databases as default), 1 column family with 5 tables in Scylla
will be created.</p>
</div></blockquote>
<p>The disadvantages of this proposal is that, we can not the TYPE command of
Redis. The different type strutures are stored in the different Scylla
tables, and each Scylla table provide the independent keyspace. In Redis,
keys are unique in the database. However,  the keys with column family of
Scylla are not unique. Beacause the keys are splited into independent
Scylla tables, it’s different to original Redis.</p>
<p><strong>IMPORTANT NOTE</strong>: The keys with database of Redis are not unique  in this
proposal, is the main difference with original Redis.</p>
<blockquote>
<div><p>This limitation is acceptable. The top layer of bussness system knows the
context of the keys.</p>
</div></blockquote>
<p>In the rest of this section, the details of schema of tables within column
family are provided.</p>
<div class="section" id="table-schema-of-strings">
<h3>4.1  Table Schema of STRINGs<a class="headerlink" href="#table-schema-of-strings" title="Permalink to this headline">¶</a></h3>
<p>In Redis, STRINGs are similar to strings that we see in other languages or
other key-value stores. Every data item only has two parts, KEY and VALUE.
The partition in the Scylla table owns the TTL property. We just need two
columns in the table to store Redis STRING data.</p>
<p>The maximum allowed key and value size is 512 MB. Very long key size is not
good idea.</p>
<p>Within the Scylla column family, we create the table named `STRINGs to
store the string structure of Redis. The table STRINGs is created by
following CQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">STRINGs</span> <span class="p">(</span>
    <span class="n">pkey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">data</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="p">)</span> <span class="n">WITH</span> <span class="o">...</span> <span class="p">;</span>
</pre></div>
</div>
<p>Every Key-Value pair is stored as one partition within STRINGs table.
All commands of STRINGs and some shared commands will operate this table.</p>
</div>
<div class="section" id="table-schema-of-lists">
<h3>4.2 Table Schema of LISTs<a class="headerlink" href="#table-schema-of-lists" title="Permalink to this headline">¶</a></h3>
<p>In Redis, LISTs store an ordered sequence of strings which sorted by
insertion order. It allows us to push items to the front and the back of
the LIST with LPUSH/RPUSH, and to pop items from the front and back of the
list with LPOP/RPOP, and to fetch an item at a given position with LINDEX,
and to fetch a range of items with LRANGE.</p>
<p>Maximum length of a list is 23^2  - 1 elements (4294967295, more than 4
billion of elements per list). And maximum length of element (as a string) is 512MB.</p>
<p>As we known, Scylla supports 3 kinds of collections, lists, maps,
and sets. We do not use the lists collection to store Redis LISTs
structure. Because, the LISTs structure in Redis may contains many
elements ( Maximum is more than 4 billion of elements per list).
When updating the lists collection in Scylla, the whole elements
will be loaded into memory.</p>
<p>The better way is that the LISTs of Redis are stored as the
partition of the Scylla table. All commons of Redis LISTs will
operate on this table, which is created by following CQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">LISTs</span> <span class="p">(</span>
    <span class="n">pkey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">ckey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">data</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">ckey</span><span class="p">)</span>
<span class="p">)</span> <span class="n">WITH</span> <span class="o">...</span> <span class="p">;</span>
</pre></div>
</div>
<p>The pkey is mapped to Redis LISTs key, and ckey is the UUID of the
insertion timestamp, which will be keep the right order as the insertion
order. The element’s value is stored in the data column within LISTs table.</p>
</div>
<div class="section" id="table-schema-of-hashes">
<h3>4.3  Table Schema of HASHes<a class="headerlink" href="#table-schema-of-hashes" title="Permalink to this headline">¶</a></h3>
<p>In Redis, HASHes are maps between the string fields and the string values.
The fields are unique within a HASH structure in Redis. The values that can
be stored in HASHes are the same as what can be stored as normal STRINGs.</p>
<p>HASHes provide constant time basic operations like HGET, HSET, HEXISTS etc.</p>
<p>As mentioned above, Scylla provides the 3 kinds of collection data type,
including map.
We do not use this collection type of Scylla to strore HASHes data with the
same reason.</p>
<p>The better way is that the HASHes of Redis are stored as the partition of
the Scylla table. All commons of Redis HASHes will operate on this table,
which is created by following CQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">HASHes</span> <span class="p">(</span>
    <span class="n">pkey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">ckey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">data</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">ckey</span><span class="p">)</span>
<span class="p">)</span> <span class="n">WITH</span> <span class="o">...</span> <span class="p">;</span>
</pre></div>
</div>
<p>The HASHes structure is stored as the partition of Scylla table. The pkey
is the partition key. The HASHes structure’s field is storted as ckey
(cluster key in HASHes table). The HASHes structure’s value is stored as
data column.</p>
</div>
<div class="section" id="table-schema-of-sets">
<h3>4.4 Table Schema of SETs<a class="headerlink" href="#table-schema-of-sets" title="Permalink to this headline">¶</a></h3>
<p>In Redis, SETs allows us to store sequence of strings, and uses a hash
table to keep all strings unique.</p>
<p>For the same reason as LISTs/HASHes, we do not use the collection type of
Scylla to store Redis SETs data. The table is created by following CQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">SETs</span> <span class="p">(</span>
    <span class="n">pkey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">ckey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">ckey</span><span class="p">)</span>
<span class="p">)</span> <span class="n">WITH</span> <span class="o">...</span> <span class="p">;</span>
</pre></div>
</div>
<p>Unlike HASHes, There is not data column in SETs table. Every SETs structure
is stored as a partition in SETs table. We use the cluster key to store the
item of Redis SETs.</p>
</div>
<div class="section" id="table-schema-of-zsets-sorted-sets">
<h3>4.5 Table Schema of ZSETs(Sorted SETs)<a class="headerlink" href="#table-schema-of-zsets-sorted-sets" title="Permalink to this headline">¶</a></h3>
<p>In fact, ZSETs in Redis is similar to HASHes, which maps the STRINGs key to
value. Like HASHes, the keys (called  MEMBERS) are unique. But the values (called
SCORES) are limited to floating-point numbers.  ZSETs have the
unique property in Redis of being able to be accessed by member (like aHASH),
but items can also be accessed by the sorted order and values of the scores.</p>
<p>Essentially speaking, the ZSETs looks like special SETs. The SETs structure
maps a key (as STRING) to a collection of STRINGs. But the ZSETs structure
maps a key (as STRING) to a collection of ITEMs which associated with a
score. It allows us to fetch data by score.</p>
<p>To store ZSETs data,  the scylla table is created by following CQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">ZSETs</span> <span class="p">(</span>
    <span class="n">pkey</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">ckey</span> <span class="n">double</span><span class="p">,</span>
    <span class="n">data</span> <span class="n">text</span><span class="p">,</span>
    <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">(</span><span class="n">pkey</span><span class="p">,</span> <span class="n">ckey</span><span class="p">)</span>
<span class="p">)</span> <span class="n">WITH</span> <span class="o">...</span> <span class="p">;</span>
</pre></div>
</div>
<p>Like other stutures mentioned above, a ZSETs strucutre is stored as a
partition within the ZSETs table.</p>
</div>
</div>
<div class="section" id="implementation-of-commands">
<h2>5. Implementation of Commands<a class="headerlink" href="#implementation-of-commands" title="Permalink to this headline">¶</a></h2>
<p>In Scylla, high write performance is achieved by ensuring that writes do
not require reads from disk. However, in Redis, the object level atomic
updates is <a class="reference external" href="https://redis.io/topics/transactions">supported</a>,  and the
transaction is supported (e.g. CAS).  In this proposal, the commands, which
require a read before the write (a.k.a read-modify-write), are implemented
in an unsafe way, that simply performs a read before the write.</p>
<p>Fortunately, the LWT is soon coming to Scylla.  By then the
read-modify-write commands will be implemented based on LWT.</p>
<p><strong>IMPORTANT NOTE</strong>:</p>
<p>The commands, that require a read before the write, are not atomic. It’s
anther difference with original Redis.</p>
<div class="section" id="rmw-command">
<h3>5.1 RMW Command<a class="headerlink" href="#rmw-command" title="Permalink to this headline">¶</a></h3>
<p>The RMW Commond is that the sequence of operations (Read-Modify-Write)
require by this command needs to be performed atomically.</p>
<p>For instance, APPEND command of STRINGs, is typical RMW command. First,
read the key from database, modify it’s value (based on the exists value),
and write the new value back. These sequence of operations should be
performed atomically.</p>
<p>As mentioned above, Scylla currently does not support LWT. The RMW commands
are implemented in an unsafe way in this proposal. It simply performs a
read before the write.</p>
<p>Assuming Scylla has supported the LWT, there is no difference with the
original Reids about the RMW commands.</p>
</div>
<div class="section" id="non-rmw-command">
<h3>5.2 Non-RMW Command<a class="headerlink" href="#non-rmw-command" title="Permalink to this headline">¶</a></h3>
<p>The Non-RMW command only performs a single read or write operation. For
instance, The SET, GET, EXISTS of STRINGs strucutures. The behaviour of
these commands are not different with the original Redis.</p>
</div>
<div class="section" id="transaction">
<h3>5.3 Transaction<a class="headerlink" href="#transaction" title="Permalink to this headline">¶</a></h3>
<p>For the same reason as RMW command, the transaction is not supported
currently.</p>
<blockquote>
<div><p>In fact, some commands (e.g. MSET of STRINGs) are also not supported,
which also need the transcation mechanism.</p>
</div></blockquote>
</div>
<div class="section" id="time-to-live-ttl">
<h3>5.4 Time to Live (TTL)<a class="headerlink" href="#time-to-live-ttl" title="Permalink to this headline">¶</a></h3>
<p>In Redis, the TTL is only specified to entrie key-value pair. Scylla has
compaction mechanism to remove expired data.  We can set the TTL the
partition for the given partition key. We also can rewrite the  partition
with new TTL value.</p>
<p>The partition ( stores the key-value pair of Redis strucutres) will be
deleted eventually, when the associated TTL is older than current
timestamp.</p>
</div>
<div class="section" id="consistency">
<h3>5.5 Consistency<a class="headerlink" href="#consistency" title="Permalink to this headline">¶</a></h3>
<p>Redis Cluster is not able to <a class="reference external" href="https://redis.io/topics/cluster-tutorial">guarantee strong
onsistency</a>.</p>
<p>In Scylla, data is always replicated automatically.  Read  or  write
operations can occur to data stored on any of the replicated nodes. The
<a class="reference external" href="https://docs.scylladb.com/glossary/#term-consistency-level-cl">Consistency Level
(CL)</a>
determines how many replicas in a cluster that must acknowledge read or
<a class="reference external" href="https://docs.scylladb.com/glossary/#term-write-operation">write
operations</a>
before it is considered successful.</p>
<p>We can use the fault tolerance mechanism of Scylla, to make the
consistency of Redis operations configurable.</p>
</div>
<div class="section" id="implementation-of-shared-commands">
<h3>5.6 Implementation of Shared Commands<a class="headerlink" href="#implementation-of-shared-commands" title="Permalink to this headline">¶</a></h3>
<p>In Redis, data structures have the shared commands (e.g. DEL, EXISTS).
And other commands usually operate on special one data structure of Redis.
As mentioned above,
we split the key set into 5 different Scylla table. The shared commands
should operate on these tables in parallel. For instance, DEL command,
which allows user to remove any key in Redis database, should delete the
given key from 5 different Scylla tables.</p>
</div>
</div>
<div class="section" id="api-reference">
<h2>6 API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h2>
<div class="section" id="commands">
<h3>Commands<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h3>
<p>The Redis API in Scylla supports the following subset of the Redis commands.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Connection</strong></td>
<td></td>
</tr>
<tr>
<td><code>ECHO message</code></td>
<td>Echo a <code>message</code> back to the client. The server returns `message´ as a response.</td>
</tr>
<tr>
<td><code>PING [message]</code></td>
<td>Check connection liveness or measure reponse time. The server returns <code>PONG</code> as a response.</td>
</tr>
<tr>
<td><code>SELECT index</code></td>
<td>Select logical database database for the current connection.</td>
</tr>
<tr>
<td><strong>Keys</strong></td>
<td></td>
</tr>
<tr>
<td><code>DEL key [key ...]</code></td>
<td>Delete <code>key</code> from the database.</td>
</tr>
<tr>
<td><code>EXISTS key [key..]</code></td>
<td>Check if <code>key</code> exists in the database.</td>
</tr>
<tr>
<td><code>TTL key</code></td>
<td>Get the time to live (TTL) for <code>key</code>.</td>
</tr>
<tr>
<td><strong>String data type</strong></td>
<td></td>
</tr>
<tr>
<td><code>GET key</code></td>
<td>Get the value for a <code>key</code>.</td>
</tr>
<tr>
<td><code>SET key value [EX seconds\|PX milliseconds] [NX\|XX] [KEEPTTL]</code></td>
<td>Set the value of <code>key</code>.</td>
</tr>
<tr>
<td><code>SETEX key seconds value</code></td>
<td>Set the value and the expiration of <code>key</code>.</td>
</tr>
<tr>
<td><strong>Hash data type</strong></td>
<td></td>
</tr>
<tr>
<td><code>HGET key field</code></td>
<td>Get the value for a <code>key</code> and <code>field</code>.</td>
</tr>
<tr>
<td><code>HSET key field value</code></td>
<td>Set the value of <code>key</code> and <code>field</code>. Multiple field/value is not yet supported. Return value is always 1 whether the key exists or not.</td>
</tr>
<tr>
<td><code>HGETALL key</code></td>
<td>Get all values for a <code>key</code>.</td>
</tr>
<tr>
<td><code>HDEL key field</code></td>
<td>Delete a value for a <code>key</code> and <code>field</code>. Return value is always the number of fields whether the fields existed or not.</td>
</tr>
<tr>
<td><code>HEXISTS key field</code></td>
<td>Returns 1 if a value exists for a <code>key</code> and <code>field</code> or 0 if it doesn't.</td>
</tr>
<tr>
<td><strong>Server</strong></td>
<td></td>
</tr>
<tr>
<td><code>LOLWUT [VERSION version]</code></td>
<td>Return Redis version.</td>
</tr>
</tbody>
</table></div>
</div>
</div>
  <div class="content-navigation">
  <div class="navigation navigation--prev">
    <a class="navigation__link" href="protocols.html">
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-left"></i>
      </button>
      <div class="navigation__title">
        <span class="colored">PREVIOUS</span> <br />Ports and protocols in Scylla
      </div>
    </a>
  </div>
  <div class="navigation navigation--next">
    <a class="navigation__link" href="repair_based_node_ops.html">
      <div class="navigation__title">
        <span class="colored">NEXT</span> <br />Repair based node operations
      </div>
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-right"></i>
      </button>
    </a>
  </div>
</div> 
      </div>
      <div
        class="sidebar-left  large-order-1"
      > <div id="side-nav" class="side-nav" data-closable data-toggler=".show">
  <div class="side-nav__search">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav__versions">
     <ul
  class="dropdown menu scylla-dropdown scylla-dropdown--versions "
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
       4.5 
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content"> 
      <li>
        <a href="redis.html"
          >4.5</a
        >
      </li>
       
      <li>
        <a href="../../branch-4.4/design-notes/redis.html"
          >4.4</a
        >
      </li>
       
    </ul>
  </li>
</ul> 
  </div>
  <div class="side-nav__content">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Scylla Developer Documentation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../alternator/alternator.html">Alternator: DynamoDB API in Scylla</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../alternator/getting-started.html">Getting Started With ScyllaDB Alternator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alternator/compatibility.html">Scylla Alternator for DynamoDB users</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Design Notes</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="scylla-icon scylla-icon--expand"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="IDL.html">IDL definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdc.html">CDC</a></li>
<li class="toctree-l2"><a class="reference internal" href="compaction_controller.html">The Compaction Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql-extensions.html">Scylla CQL extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql-extensions-internal.html">Scylla CQL extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql3-type-mapping.html">CQL3 Type Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="hinted_handoff_design.html">Hinted Handoff Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="isolation.html">Performance Isolation in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="lua-type-mapping.html">CQL to Lua type mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html">Scylla Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating-from-users-to-roles.html">Migrating from users to roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="paged-queries.html">Paged queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol-extensions.html">Protocol extensions to the Cassandra Native Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocols.html">Ports and protocols in Scylla</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Redis API in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="repair_based_node_ops.html">Repair based node operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="row_cache.html">Row Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="row_level_repair.html">Row level repair</a></li>
<li class="toctree-l2"><a class="reference internal" href="secondary_index.html">Secondary indexes in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="sstable-scylla-format.html">File format of the Scylla.db sstable component</a></li>
<li class="toctree-l2"><a class="reference internal" href="sstables-directory-structure.html">sstables directory structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_keyspace.html">System keyspace layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_schema_keyspace.html">System schema keyspace layout</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../guides/index.html">Guides</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../guides/HACKING.html">Guidelines for developing Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/api_v2.html">Scylla RESTful API V2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/building.html">Building Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/debugging.html">Debugging with GDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/docker-hub.html">Docker Hub Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/logging.html">Logging in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../guides/tracing.html">Tracing</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contribute/index.html">Contribute</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="scylla-icon scylla-icon--expand"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contribute/CONTRIBUTING.html">Contributing to Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/backport.html">Backport</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/maintainer.html">Maintainer’s handbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribute/review-checklist.html">Review Checklist</a></li>
</ul>
</li>
</ul>

  </div>
</div>
      </div>
      
      <div class="sidebar-right large-order-3">
         <div class="secondary-side-nav">
  <div class="secondary-side-nav__content">
    <p class="topic-title">On this page</p>
    <ul>
<li><a class="reference internal" href="#">Redis API in Scylla</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#motivation">2. Motivation</a></li>
<li><a class="reference internal" href="#the-protocol-server">3. The Protocol Server</a></li>
<li><a class="reference internal" href="#data-model">4. Data Model</a><ul>
<li><a class="reference internal" href="#table-schema-of-strings">4.1  Table Schema of STRINGs</a></li>
<li><a class="reference internal" href="#table-schema-of-lists">4.2 Table Schema of LISTs</a></li>
<li><a class="reference internal" href="#table-schema-of-hashes">4.3  Table Schema of HASHes</a></li>
<li><a class="reference internal" href="#table-schema-of-sets">4.4 Table Schema of SETs</a></li>
<li><a class="reference internal" href="#table-schema-of-zsets-sorted-sets">4.5 Table Schema of ZSETs(Sorted SETs)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-commands">5. Implementation of Commands</a><ul>
<li><a class="reference internal" href="#rmw-command">5.1 RMW Command</a></li>
<li><a class="reference internal" href="#non-rmw-command">5.2 Non-RMW Command</a></li>
<li><a class="reference internal" href="#transaction">5.3 Transaction</a></li>
<li><a class="reference internal" href="#time-to-live-ttl">5.4 Time to Live (TTL)</a></li>
<li><a class="reference internal" href="#consistency">5.5 Consistency</a></li>
<li><a class="reference internal" href="#implementation-of-shared-commands">5.6 Implementation of Shared Commands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api-reference">6 API Reference</a><ul>
<li><a class="reference internal" href="#commands">Commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
</div> 
      </div>
    </section>

    <footer class="footer">
  <div class="footer-group">
    <div class="footer-top">
      <a class="footer-logo" href="https://www.scylladb.com"
        ><img
          src="../_static/img/logo-scylla-horizontal-RGB.svg"
          alt="Logo"
      /></a>
      <div class="footer-links">
        <a class="footer-links__link" href="https://docs.scylladb.com/">Docs</a>
        <a
          class="footer-links__link"
          href="https://www.scylladb.com/company/contact-us/"
          >Contact Us</a
        >
        <a class="footer-links__link" href="https://www.scylladb.com/company/"
          >About Us</a
        >
      </div>
      <div class="footer-actions">
        <a
          class="footer-actions__link"
          href="https://groups.google.com/g/scylladb-users"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User mailing list"
            data-position="bottom"
          >
            <img
              src="../_static/img/icons/icon-mail-list.svg"
              alt="Mail List Icon"
            />
          </span>
        </a>
        <a
          class="footer-actions__link"
          href="http://slack.scylladb.com/"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User Slack channel"
            data-position="bottom"
          >
            <img
              src="../_static/img/icons/icon-slack.svg"
              alt="Slack Icon"
          /></span>
        </a>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="footer-bottom__copyright"> &#169; 2021, ScyllaDB. All rights reserved.
      </div>
      <div class="footer-bottom__last-updated">
        Last updated on 02 December 2021.
      </div>
      <div class="footer-bottom__version">
        Powered by
        <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a> &amp;
        <a href="https://sphinx-theme.scylladb.com/"
          >ScyllaDB Theme 1.0.5</a
        >
      </div>
    </div>
  </div>
</footer>

    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe>
    </noscript>
  </body>
</html>